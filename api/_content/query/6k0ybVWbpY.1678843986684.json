{"_path":"/algorithm/leetcode/lc-1114","_dir":"leetcode","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"LC1114 解题方案","description":"","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"lc1114-解题方案"},"children":[{"type":"text","value":"LC1114 解题方案"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://leetcode.cn/problems/print-in-order/solution/c-hu-chi-suo-tiao-jian-bian-liang-xin-hao-liang-yi/","rel":["nofollow"]},"children":[{"type":"text","value":"参考"}]}]}]},{"type":"element","tag":"h2","props":{"id":"互斥锁"},"children":[{"type":"element","tag":"a","props":{"href":"../cpp/mutex"},"children":[{"type":"text","value":"互斥锁"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"互斥锁是用来防止多个线程同时访问共享资源对象的机制，在同一时间只有一个线程可以拥有一个特定的锁对象，\n其他线程如果尝试获取锁会阻塞直到锁资源被释放或直接返回失败。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"mutex 对象本身是不保护任何数据的，我们只是通过 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mutex"}]},{"type":"text","value":" 的机制来保护数据被同时访问，\n所以最好使用 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"lock_guard"}]},{"type":"text","value":" 或者 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"unique_lock"}]},{"type":"text","value":" 提供的 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"RAII"}]},{"type":"text","value":" 机制来管理 mutex 对象，\n而不是直接操作 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mutex"}]},{"type":"text","value":" 对象。其中 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"lock_guard"}]},{"type":"text","value":" 只拥有构造和析构函数，用来实现 RAII 机制；\n而 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"unique_lock"}]},{"type":"text","value":" 是一个完整的 mutex 所有权包装器，封装了所有 mutex 的函数："}]},{"type":"element","tag":"code","props":{"code":"class Foo {\n    mutex mtx_1, mtx_2;\n    unique_lock<mutex> lock_1, lock_2;\npublic:\n    Foo() : lock_1(mtx_1, try_to_lock), lock_2(mtx_2, try_to_lock) {\n    }\n\n    void first(function<void()> printFirst) {\n        printFirst();\n        lock_1.unlock();\n    }\n\n    void second(function<void()> printSecond) {\n        lock_guard<mutex> guard(mtx_1);\n        printSecond();\n        lock_2.unlock();\n    }\n\n    void third(function<void()> printThird) {\n        lock_guard<mutex> guard(mtx_2);\n        printThird();\n    }\n};\n","language":"cpp","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"Foo"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    mutex mtx_1, mtx_2;"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    unique_lock"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"mutex"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" lock_1, lock_2;"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"public:"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"Foo"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"() : "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"lock_1"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"(mtx_1, try_to_lock), "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"lock_2"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"(mtx_2, try_to_lock) {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"first"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printFirst"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printFirst"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        lock_1."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"unlock"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"second"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printSecond"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        lock_guard"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"mutex"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"guard"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"(mtx_1);"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printSecond"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        lock_2."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"unlock"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"third"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printThird"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        lock_guard"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"mutex"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"guard"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"(mtx_2);"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printThird"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"};"}]}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"条件变量"},"children":[{"type":"text","value":"条件变量"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"条件变量一般和互斥锁搭配使用，互斥锁用于上锁，条件变量用于在多线程环境中等待特定事件发生。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"针对这道题我们可以分别在 first 和 second 执行完之后修改特定变量的值（例如修改成员变量 k 为特定值），然后通知条件变量，唤醒下一个函数继续执行。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::condition_variable"}]},{"type":"text","value":" 是一种用来同时阻塞多个线程的同步原语（synchronization primitive），"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::condition_variable"}]},{"type":"text","value":" 必须和 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::unique_lock"}]},{"type":"text","value":" 搭配使用："}]},{"type":"element","tag":"code","props":{"code":"class Foo {\n    condition_variable cv;\n    mutex mtx;\n    int k = 0;\npublic:\n    void first(function<void()> printFirst) {\n        printFirst();\n        k = 1;\n        cv.notify_all();    // 通知其他所有在等待唤醒队列中的线程\n    }\n\n    void second(function<void()> printSecond) {\n        unique_lock<mutex> lock(mtx);   // lock mtx\n        cv.wait(lock, [this](){ return k == 1; });  // unlock mtx，并阻塞等待唤醒通知，需要满足 k == 1 才能继续运行\n        printSecond();\n        k = 2;\n        cv.notify_one();    // 随机通知一个（unspecified）在等待唤醒队列中的线程\n    }\n\n    void third(function<void()> printThird) {\n        unique_lock<mutex> lock(mtx);   // lock mtx\n        cv.wait(lock, [this](){ return k == 2; });  // unlock mtx，并阻塞等待唤醒通知，需要满足 k == 2 才能继续运行\n        printThird();\n    }\n};\n","language":"cpp","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"Foo"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    condition_variable cv;"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    mutex mtx;"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" k "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"public:"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"first"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printFirst"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printFirst"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        k "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        cv."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"notify_all"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]},{"type":"element","tag":"span","props":{"class":"ct-2eb74c"},"children":[{"type":"text","value":"    // 通知其他所有在等待唤醒队列中的线程"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"second"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printSecond"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        unique_lock"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"mutex"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"lock"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"(mtx);"}]},{"type":"element","tag":"span","props":{"class":"ct-2eb74c"},"children":[{"type":"text","value":"   // lock mtx"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        cv."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"wait"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"(lock, ["}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"](){ "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" k "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"; });"}]},{"type":"element","tag":"span","props":{"class":"ct-2eb74c"},"children":[{"type":"text","value":"  // unlock mtx，并阻塞等待唤醒通知，需要满足 k == 1 才能继续运行"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printSecond"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        k "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        cv."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"notify_one"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]},{"type":"element","tag":"span","props":{"class":"ct-2eb74c"},"children":[{"type":"text","value":"    // 随机通知一个（unspecified）在等待唤醒队列中的线程"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"third"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printThird"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        unique_lock"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"mutex"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"lock"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"(mtx);"}]},{"type":"element","tag":"span","props":{"class":"ct-2eb74c"},"children":[{"type":"text","value":"   // lock mtx"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        cv."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"wait"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"(lock, ["}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"](){ "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" k "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"; });"}]},{"type":"element","tag":"span","props":{"class":"ct-2eb74c"},"children":[{"type":"text","value":"  // unlock mtx，并阻塞等待唤醒通知，需要满足 k == 2 才能继续运行"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printThird"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"};"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::condition_variable::wait"}]},{"type":"text","value":" 函数会执行三个操作：\n先将当前线程加入到等待唤醒队列，然后 unlock mutex 对象，最后阻塞当前线程。\n它有两种重载形式，第一种只接收一个 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::mutex"}]},{"type":"text","value":" 对象，\n此时线程一旦接受到唤醒信号（通过 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::condition_variable::notify_one"}]},{"type":"text","value":" 或 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::condition_variable::notify_all"}]},{"type":"text","value":" 进行唤醒），\n则无条件立即被唤醒，并重新 lock mutex；\n第二种重载形式还会接收一个条件（一般是 variable 或者 std::function），即只有当满足这个条件时，当前线程才能被唤醒，\n它在 gcc 中的实现也很简单，只是在第一种重载形式之外加了一个 while 循环来保证只有在满足给定条件后才被唤醒，否则重新调用 wait 函数："}]},{"type":"element","tag":"code","props":{"code":"template<typename _Predicate>\nvoid wait(unique_lock<mutex>& __lock, _Predicate __p)\n{\n    while (!__p())\n        wait(__lock);\n}\n","language":"cpp","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"template"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"typename"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"_Predicate"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":">"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"wait"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"unique_lock"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"mutex"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"&"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"__lock"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"_Predicate"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"__p"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":")"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"{"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"while"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"__p"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"())"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"wait"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"(__lock);"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"信号量"},"children":[{"type":"text","value":"信号量"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"信号量是用来实现对共享资源的同步访问的机制，其使用方法和条件变量类似，都是通过主动等待和主动唤醒来实现的。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"c++ 标准库中并没有信号量的实现和封装，可以用 c 语言提供的 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"<sempahore.h>"}]},{"type":"text","value":" 库来解题 ："}]},{"type":"element","tag":"code","props":{"code":"#include <semaphore.h>\n\nclass Foo {\nprivate:\n    sem_t sem_1, sem_2;\n\npublic:\n    Foo() {\n        sem_init(&sem_1, 0, 0), sem_init(&sem_2, 0, 0);\n    }\n\n    void first(function<void()> printFirst) {\n        printFirst();\n        sem_post(&sem_1);\n    }\n\n    void second(function<void()> printSecond) {\n        sem_wait(&sem_1);\n        printSecond();\n        sem_post(&sem_2);\n    }\n\n    void third(function<void()> printThird) {\n        sem_wait(&sem_2);\n        printThird();\n    }\n};\n","language":"cpp","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"#include"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-8697ca"},"children":[{"type":"text","value":"<semaphore.h>"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"Foo"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"private:"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"sem_t"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" sem_1, sem_2;"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"public:"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"Foo"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"() {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"sem_init"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"&"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"sem_1, "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"), "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"sem_init"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"&"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"sem_2, "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"first"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printFirst"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printFirst"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"sem_post"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"&"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"sem_1);"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"second"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printSecond"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"sem_wait"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"&"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"sem_1);"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printSecond"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"sem_post"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"&"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"sem_2);"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"third"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printThird"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"sem_wait"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"&"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"sem_2);"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printThird"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"};"}]}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"异步操作"},"children":[{"type":"text","value":"异步操作"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"异步操作是一种，在不需要等待被调用方返回结果之前，就让操作继续进行下去的方法。针对这道题可以使用基于 future/promise 的异步编程模型。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"future 和 promise 起源于函数式编程，其目的是将值（future）和计算方式（promise）分离，使得 promise 可以异步地修改 future，从而提高代码的可读性，并减少通信延迟。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::future"}]},{"type":"text","value":" 是用来获取异步操作结果的模板类；"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::packaged_task"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::promise"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::async"}]},{"type":"text","value":" 都可以进行异步操作，\n并拥有一个 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::future"}]},{"type":"text","value":" 对象，用来存储它们所进行的异步操作返回或设置的值（或异常），\n这个值会在将来的某一个时间点，通过某种机制被修改后，保存在其对应的 std::future 对象中："}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"对于 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::promise"}]},{"type":"text","value":"，可以通过调用 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::promise::set_value"}]},{"type":"text","value":" 来设置值并通知 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::future"}]},{"type":"text","value":" 对象："}]},{"type":"element","tag":"code","props":{"code":"class Foo {\n    promise<void> pro1, pro2;\n\npublic:\n    void first(function<void()> printFirst) {\n        printFirst();\n        pro1.set_value();\n    }\n\n    void second(function<void()> printSecond) {\n        pro1.get_future().wait();\n        printSecond();\n        pro2.set_value();\n    }\n\n    void third(function<void()> printThird) {\n        pro2.get_future().wait();\n        printThird();\n    }\n};\n","language":"cpp","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"Foo"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    promise"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"<void>"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" pro1, pro2;"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"public:"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"first"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printFirst"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printFirst"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        pro1."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"set_value"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"second"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printSecond"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        pro1."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"get_future"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"wait"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printSecond"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        pro2."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"set_value"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"third"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printThird"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        pro2."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"get_future"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"wait"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printThird"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"};"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::future<T>::wait"}]},{"type":"text","value":" 和 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::future<T>::get"}]},{"type":"text","value":" 都会阻塞地等待拥有它的 promise 对象返回其所存储的值，\n后者还会获取 T 类型的对象；这道题只需要利用到异步通信的机制，所以并没有返回任何实际的值。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::packaged_task"}]},{"type":"text","value":" 是一个拥有 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::future"}]},{"type":"text","value":" 对象的 functor，将一系列操作进行了封装，\n在运行结束之后会将返回值保存在其所拥有的 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::future<T>"}]},{"type":"text","value":" 对象中；同样地，在这道题中只需要利用到其函数运行结束之后通知 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"std::future"}]},{"type":"text","value":" 对象的机制："}]},{"type":"element","tag":"code","props":{"code":"class Foo {\n    function<void()> task = []() {};\n    packaged_task<void()> pt_1{ task }, pt_2{ task };\n\npublic:\n    void first(function<void()> printFirst) {\n        printFirst();\n        pt_1();\n    }\n\n    void second(function<void()> printSecond) {\n        pt_1.get_future().wait();\n        printSecond();\n        pt_2();\n    }\n\n    void third(function<void()> printThird) {\n        pt_2.get_future().wait();\n        printThird();\n    }\n};\n","language":"cpp","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"Foo"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    function"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"<void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" task "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" []() {};"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    packaged_task"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"<void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" pt_1{ task }, pt_2{ task };"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"public:"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"first"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printFirst"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printFirst"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"pt_1"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"second"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printSecond"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        pt_1."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"get_future"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"wait"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printSecond"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"pt_2"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"third"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printThird"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        pt_2."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"get_future"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()."}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"wait"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printThird"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"};"}]}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"原子操作"},"children":[{"type":"element","tag":"a","props":{"href":"../cpp/atomic"},"children":[{"type":"text","value":"原子操作"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我们平时进行的数据修改都是非原子操作，如果多个线程同时以非原子操作的方式修改同一个对象可能会发生数据争用， 从而导致未定义行为；\n而原子操作能够保证多个线程顺序访问，不会导致数据争用，其执行时没有任何其它线程能够修改相同的原子对象。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"针对这道题，我们可以让 second 和 third 函数等待原子变量被修改为某个值后再执行，然后分别在 first 和 second 函数中来修改这个原子变量。"}]},{"type":"element","tag":"code","props":{"code":"class Foo {\n    std::atomic<bool> a{ false };\n    std::atomic<bool> b{ false };\npublic:\n    void first(function<void()> printFirst) {\n        printFirst();\n        a = true;\n    }\n\n    void second(function<void()> printSecond) {\n        while (!a)\n            this_thread::sleep_for(chrono::milliseconds(1));\n        printSecond();\n        b = true;\n    }\n\n    void third(function<void()> printThird) {\n        while (!b)\n            this_thread::sleep_for(chrono::milliseconds(1));\n        printThird();\n    }\n};\n","language":"cpp","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"Foo"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"std"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"::atomic"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"<bool>"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" a{ "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"false"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" };"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"std"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"::atomic"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"<bool>"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" b{ "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"false"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" };"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"public:"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"first"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printFirst"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printFirst"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        a "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"second"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printSecond"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"while"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"a)"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"            "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"this_thread"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"sleep_for"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"chrono"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"milliseconds"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"));"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printSecond"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        b "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"third"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"()> "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"printThird"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"while"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-a754d8"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"b)"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"            "}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"this_thread"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"sleep_for"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-e31d1a"},"children":[{"type":"text","value":"chrono"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"milliseconds"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-aa63a1"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"));"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-b98fd4"},"children":[{"type":"text","value":"printThird"}]},{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-49aedb"},"children":[{"type":"text","value":"};"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"值得注意的是，原子操作的实现跟处理器和操作系统内核相关，因此 c++ 标准并没有规定 atomic 的实现是否是无锁的（lock-free），\n只规定了需要提供一个 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"is_lock_free()"}]},{"type":"text","value":" 来查询当前编译器对 atomic 的实现是否是无锁的。"}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-8697ca{color:#0A3069}\n.ct-2eb74c{color:#6E7781}\n.ct-aa63a1{color:#0550AE}\n.ct-b98fd4{color:#8250DF}\n.ct-e31d1a{color:#953800}\n.ct-49aedb{color:#24292F}\n.ct-a754d8{color:#CF222E}\n.dark .ct-a754d8{color:#FF7B72}\n.dark .ct-49aedb{color:#C9D1D9}\n.dark .ct-e31d1a{color:#FFA657}\n.dark .ct-b98fd4{color:#D2A8FF}\n.dark .ct-aa63a1{color:#79C0FF}\n.dark .ct-2eb74c{color:#8B949E}\n.dark .ct-8697ca{color:#A5D6FF}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"互斥锁","depth":2,"text":"互斥锁"},{"id":"条件变量","depth":2,"text":"条件变量"},{"id":"信号量","depth":2,"text":"信号量"},{"id":"异步操作","depth":2,"text":"异步操作"},{"id":"原子操作","depth":2,"text":"原子操作"}]}},"_type":"markdown","_id":"content:2.algorithm:2.leetcode:lc-1114.md","_source":"content","_file":"2.algorithm/2.leetcode/lc-1114.md","_extension":"md"}