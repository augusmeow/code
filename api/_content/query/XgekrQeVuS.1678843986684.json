{"_path":"/interview/thread","_dir":"interview","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"线程","description":"","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"线程"},"children":[{"type":"text","value":"线程"}]},{"type":"element","tag":"h2","props":{"id":"数据互斥"},"children":[{"type":"text","value":"数据互斥"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在多线程存在的环境中，除了堆栈中的临时数据之外，所有的数据都是共享的。如果我们需要线程之间正确地运行，那么务必需要保证公共数据的执行和计算是正确的。简单一点说，就是保证数据在执行的时候必须是互斥的。否则，如果两个或者多个线程在同一时刻对数据进行了操作，那么后果是不可想象的。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"todo todo todo"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"那么，有什么办法可以保证在某一时刻只有一个线程对数据进行操作呢？四个基本方法："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"关中断"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"数学互斥方法"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"操作系统提供的互斥方法"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"cpu原子操作"}]}]},{"type":"element","tag":"h3","props":{"id":"关中断"},"children":[{"type":"text","value":"关中断"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"要让数据在某一时刻只被一个线程访问，方法之一就是停止线程调度就可以了。那么怎样停止线程调度呢？那么关掉时钟中断就可以了啊。在X86里面的确存在这样的两个指令"}]},{"type":"element","tag":"code","props":{"code":"#include <stdio.h>\nint main () {\n    __asm {\n        cli\n        sti\n    }\n    return 1;\n}\n","language":"c","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"#include"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3dfa2a"},"children":[{"type":"text","value":"<stdio.h>"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-d3fc83"},"children":[{"type":"text","value":"main"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" () {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"    __asm {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"        cli"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"        sti"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-a0bb02"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"其中cli是关中断，sti是开中断。这段代码没有什么问题，可以编过，当然也可以生成执行文件。但是在执行的时候会出现一个异常告警：Unhandled exception in test.exe: 0xC0000096:  Privileged Instruction。告警已经说的很清楚了，这是一个特权指令。只有系统或者内核本身才可以使用这个指令。"}]},{"type":"element","tag":"h3","props":{"id":"数学互斥方法"},"children":[{"type":"text","value":"数学互斥方法"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"假设有两个线程（a、b）正要对一个共享数据进行访问，那么怎么做到他们之间的互斥的呢？其实我们可以这么做"}]},{"type":"element","tag":"code","props":{"code":"unsigned flag[2] = {0};\nunsigned turn = 0;\n\nvoid process (unsigned index) {\n    flag[index] = 1;\n    turn = index;\n    while (flag[1 - index] && (turn == index)) {\n        // do something\n    }\n}\n","language":"cpp","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"unsigned"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" flag["}]},{"type":"element","tag":"span","props":{"class":"ct-a0bb02"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"] "}]},{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" {"}]},{"type":"element","tag":"span","props":{"class":"ct-a0bb02"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"};"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"unsigned"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" turn "}]},{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-a0bb02"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-d3fc83"},"children":[{"type":"text","value":"process"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"unsigned"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-053100"},"children":[{"type":"text","value":"index"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":") {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"    flag[index] "}]},{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-a0bb02"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"    turn "}]},{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" index;"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"while"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" (flag["}]},{"type":"element","tag":"span","props":{"class":"ct-a0bb02"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" index] "}]},{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"&&"}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" (turn "}]},{"type":"element","tag":"span","props":{"class":"ct-687e35"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":" index)) {"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-06b5b9"},"children":[{"type":"text","value":"        // do something"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-3491c1"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"操作系统提供的互斥方法"},"children":[{"type":"text","value":"操作系统提供的互斥方法"}]},{"type":"element","tag":"h3","props":{"id":"cpu原子操作"},"children":[{"type":"text","value":"cpu原子操作"}]},{"type":"element","tag":"h2","props":{"id":"线程间同步"},"children":[{"type":"text","value":"线程间同步"}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-06b5b9{color:#6E7781}\n.ct-053100{color:#953800}\n.ct-a0bb02{color:#0550AE}\n.ct-d3fc83{color:#8250DF}\n.ct-3dfa2a{color:#0A3069}\n.ct-3491c1{color:#24292F}\n.ct-687e35{color:#CF222E}\n.dark .ct-687e35{color:#FF7B72}\n.dark .ct-3491c1{color:#C9D1D9}\n.dark .ct-3dfa2a{color:#A5D6FF}\n.dark .ct-d3fc83{color:#D2A8FF}\n.dark .ct-a0bb02{color:#79C0FF}\n.dark .ct-053100{color:#FFA657}\n.dark .ct-06b5b9{color:#8B949E}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"数据互斥","depth":2,"text":"数据互斥","children":[{"id":"关中断","depth":3,"text":"关中断"},{"id":"数学互斥方法","depth":3,"text":"数学互斥方法"},{"id":"操作系统提供的互斥方法","depth":3,"text":"操作系统提供的互斥方法"},{"id":"cpu原子操作","depth":3,"text":"cpu原子操作"}]},{"id":"线程间同步","depth":2,"text":"线程间同步"}]}},"_type":"markdown","_id":"content:4.interview:thread.md","_source":"content","_file":"4.interview/thread.md","_extension":"md"}